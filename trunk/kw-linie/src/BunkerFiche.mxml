<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute"
	xmlns:hc="com.hillelcoren.components.*"
	creationComplete="creationComplete();"
	backgroundColor="#637449" 
	themeColor="#637449" 
	backgroundGradientColors="[#637449,#637449]" 
	xmlns:xyz="mx.rpc.*" xmlns:local="*">

	<mx:Script>
		<![CDATA[
			import com.google.maps.LatLng;
			import mx.collections.ArrayCollection;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.events.FaultEvent;
			import mx.controls.Alert;
			import mx.core.IFlexDisplayObject;
			import mx.managers.PopUpManager;
			
			[Bindable]
			public var googleMapsKey: String;
			
			public function creationComplete() : void {
				bunkerFindAllResponder.token = bunkerService.findAll();
				googleMapsKey = GoogleMapKeys.getKey(application.url);
			}
			
			public function onFault(event: FaultEvent) : void {
				Alert.show(event.message.toString());
			}
			
			public function onResult(event: ResultEvent) : void {
				Alert.show(event.result.toString());
			}
			
			public function isEmpty(ti: TextInput) : Boolean {
				return (ti.text == null) || (ti.text == "");
			}
			
			public function gemeenteLabelFunction(item : Object) : String {
				return item.naam + " (" + item.postcode + ")";
			}				
			
			public function textinputToString(ti: TextInput) : Object {
				if (isEmpty(ti)) {
					return null;
				} else {
					return ti.text;
				}
			}
			
			public function textinputToInteger(ti: TextInput) : Object {
				if (isEmpty(ti)) {
					return null;
				} else {
					return int(ti.text);
				}
			}
			
			public function textinputToFloat(ti: TextInput) : Object {
				if (isEmpty(ti)) {
					return null;
				} else {
					return Number(ti.text);
				}
			}
			
			public function checkboxToBoolean(cb: CheckBox) : Object {
				if (cb.enabled) {
					return cb.selected;
				} else {
					return null;
				}
			}
			
			public function autocompleteToGemeenteID(ac: AutoComplete) : Object {
				if (ac.selectedItem != null) {
					return ac.selectedItem.gemeente_id;
				} else {
					return null;
				}
			}
			
			public function findByIDResult(event : ResultEvent) : void {
				_bunker = event.result;
			}
			
			[Bindable]
			public var _bunker: Object;
			
			public function bunkerGridChange(event: Event) : void {
				bunkerResponder.token = bunkerService.findByID(bunkerGrid.selectedItem.bunker_id);
			}
			
			public function bind() : Object {
				var bunker : Object = new Object();
				
				bunker.gemeente = autocompleteToGemeenteID(ac_gemeente);
				bunker.straat = textinputToString(ti_straat);
				bunker.straatnr = textinputToString(ti_straatnr);
				bunker.toponiem = textinputToString(ti_toponiem);
				bunker.x = textinputToInteger(ti_x);
				bunker.y = textinputToInteger(ti_y);
				bunker.lat = textinputToFloat(ti_lat);
				bunker.lng = textinputToFloat(ti_lng);
				bunker.kadaster = textinputToString(ti_kadaster);
				
				bunker.availGrondplan = checkboxToBoolean(cb_availGrondplan);
				bunker.availOnteigeningsdossier = checkboxToBoolean(cb_availOnteigeningsdossier);
				bunker.availLastenboek = checkboxToBoolean(cb_availLastenboek);
				bunker.availMilitairBunkerdossier = checkboxToBoolean(cb_availMilitairBunkerdossier);
				
				return bunker;
			}
			
		]]>
	</mx:Script>

	
	<xyz:CallResponder id="gemeenteResponder" />

	<mx:RemoteObject id="gemeenteService"
		source="kwl.GemeenteService" 
		destination="amfphp">
    </mx:RemoteObject>

	<xyz:CallResponder id="bunkerResponder" result="findByIDResult(event)" />
	
	<xyz:CallResponder id="bunkerFindAllResponder" />
	
	<mx:RemoteObject id="bunkerService"
		source="kwl.BunkerService" 
		destination="amfphp">
		<mx:method 
			name="save" 
			fault="onFault(event)" 
			result="onResult(event)" />
    </mx:RemoteObject>

    <mx:NumberValidator 
        source="{ti_x}"
        property="text" 
        minValue="100000"
        maxValue="300000"
        required="false"
        domain="int"/>

    <mx:NumberValidator 
        source="{ti_y}"
        property="text" 
        minValue="100000"
        maxValue="300000"
        required="false"
        domain="int"/>
        
   <mx:ArrayCollection id="gemeentes" source="{gemeenteResponder.lastResult}" />

	<mx:VBox width="728">
		<mx:DataGrid id="bunkerGrid"
			dataProvider="{bunkerFindAllResponder.lastResult}" 
			width="100%"
			change="bunkerGridChange(event)">
			<mx:columns>
				<mx:DataGridColumn dataField="bunker_id" headerText="ID" width="40" />
				<mx:DataGridColumn dataField="nummer" headerText="Nummer" width="64" />
				<mx:DataGridColumn dataField="type" headerText="Type" width="128" />
				<mx:DataGridColumn dataField="gemeente" headerText="Gemeente" />
				<mx:DataGridColumn dataField="deelgemeente" headerText="Deelgemeente" />
			</mx:columns>
		</mx:DataGrid>
		<mx:HBox>
			<mx:FormItem label="Nummer" horizontalAlign="left">
				<mx:TextInput editable="false" width="64" text="{_bunker.nummer}" />
			</mx:FormItem>
			<mx:FormItem label="Type">
				<mx:TextInput editable="false" width="128" text="{_bunker.type}" />
			</mx:FormItem>
		</mx:HBox>
		<mx:TabNavigator width="100%" height="410" creationPolicy="all">
			<mx:Canvas label="Locatie" width="100%" height="100%">
				<mx:Form x="10" y="10">
					<mx:FormItem label="Gemeente">
						<hc:AutoComplete id="ac_gemeente"
							style="underline"
							creationComplete="gemeenteResponder.token = gemeenteService.findAll()"
							dataProvider="{gemeentes}"
							labelFunction="gemeenteLabelFunction"
							matchType="anyPart">
						</hc:AutoComplete>
   					</mx:FormItem>
					<mx:FormItem label="Toponiem">
						<mx:TextInput id="ti_toponiem" text="{_bunker.toponiem}"/>
					</mx:FormItem>
					<mx:FormItem label="Adres" direction="horizontal">
						<mx:TextInput id="ti_straat" text="{_bunker.straat}"/>
						<mx:FormItem label="nr">
							<mx:TextInput id="ti_straatnr" width="64" text="{_bunker.straatnr}"/>
						</mx:FormItem>
					</mx:FormItem>
					<mx:FormItem label="Stafkaart">
						<mx:TextInput id="ti_stafkaart" text="{_bunker.stafkaart}" />
					</mx:FormItem>
					<mx:FormItem label="Lambert 72 x" direction="horizontal">
						<mx:TextInput id="ti_x" width="128" text="{_bunker.x}" />
						<mx:FormItem label="Lambert 72 y" labelWidth="100">
							<mx:TextInput id="ti_y" width="128" text="{_bunker.y}" />
						</mx:FormItem>
					</mx:FormItem>
					<mx:FormItem label="Google lat" direction="horizontal">
						<mx:TextInput id="ti_lat" width="128" text="{_bunker.lat}" />
						<mx:FormItem label="Google lng" labelWidth="100">
							<mx:TextInput id="ti_lng" width="128" text="{_bunker.lng}" />
						</mx:FormItem>
						<mx:Button label="kaart">
							<mx:click>
								<![CDATA[
								var mapPopup: MapPopup = new MapPopup();
								mapPopup.googleMapsKey = googleMapsKey;
									mapPopup.latLng = new LatLng(
									textinputToFloat(ti_lat) as Number,
									textinputToFloat(ti_lng) as Number);
								mapPopup.addEventListener("ok",function () {
									ti_lat.text = mapPopup.latLng.lat().toString();
									ti_lng.text = mapPopup.latLng.lng().toString();
								});
								PopUpManager.addPopUp(mapPopup,this,true);
								PopUpManager.centerPopUp(mapPopup);
												]]>
							</mx:click>
						</mx:Button>
					</mx:FormItem>
					<mx:FormItem label="Kadastrale gegevens">
						<mx:TextInput id="ti_kadaster" text="{_bunker.kadaster}" />
					</mx:FormItem>
				</mx:Form>
			</mx:Canvas>
			<mx:Canvas label="Docs" width="100%" height="100%">
				<mx:Form x="10" y="10">
					<mx:FormItem label="Voorhanden">
						<mx:CheckBox 
							id="cb_availGrondplan" 
							selected="{_bunker.availGrondplan}" 
							label="Grondplan" />
						<mx:CheckBox 
							id="cb_availOnteigeningsdossier" 
							selected="{_bunker.availOnteigeningsdossier}" 
							label="Onteigeningsdossier"/>
						<mx:CheckBox 
							id="cb_availLastenboek" 
							selected="{_bunker.availLastenboek}" 
							label="Lastenboek"/>
						<mx:CheckBox 
							id="cb_availMilitairBunkerdossier" 
							selected="{_bunker.availMilitairBunkerdossier}" 
							label="Militair bunkerdossier"/>
						<mx:CheckBox 
							id="cb_availOvergave" 
							selected="{_bunker.availOvergave}" 
							label="Overgave landsverdediging aan domeinen"/>
						<mx:CheckBox 
							id="cb_availVerkoopDomeinen" 
							selected="{_bunker.availVerkoopDomeinen}" 
							label="Verkoop door domeinen"/>
						<mx:CheckBox 
							id="cb_availOudeFotos" 
							selected="{_bunker.availOudeFotos}" 
							label="Oude fotos"/>
						<mx:CheckBox 
							id="cb_availAndere" 
							selected="{_bunker.availAndere}" 
							label="Andere" />
						<mx:TextInput
							id="ti_availAndereTekst"
							enabled="{cb_availAndere.selected}"
							text="{_bunker.availAndereTekst}"/>
					</mx:FormItem>
				</mx:Form>
			</mx:Canvas>
			<mx:Canvas label="Contacten" width="100%" height="100%">
			</mx:Canvas>
		</mx:TabNavigator>
	<mx:Button label="save" enabled="false" click="bunkerService.save(bind());"/>
	</mx:VBox>
</mx:Application>
