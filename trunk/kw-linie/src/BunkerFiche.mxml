<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute"
	creationComplete="creationComplete();"
	backgroundColor="#637449" 
	themeColor="#637449" 
	backgroundGradientColors="[#637449,#637449]" 
	xmlns:xyz="mx.rpc.*"
	xmlns:local="*"
	xmlns:bunkerFiche="bunkerFiche.*">

	<mx:Script>
		<![CDATA[
			import bunkerFiche.Documenten;
			import util.BindingUtils;
			import mx.controls.ComboBox;
			import mx.collections.ArrayCollection;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.events.FaultEvent;
			import mx.controls.Alert;
			
			public function creationComplete() : void {
				bunkerFindAllResponder.token = bunkerService.findAll();
				//googleMapsKey = GoogleMapKeys.getKey(application.url);
			}
			
			public function onFault(event: FaultEvent) : void {
				Alert.show(event.message.toString());
			}
			
			public function onResult(event: ResultEvent) : void {
				Alert.show(event.result.toString());
			}
			
			public function bunkerGridChange(event: Event) : void {
				if (bunkerGrid.selectedItem != null) {
					bunkerResponder.token = bunkerService.findByID(bunkerGrid.selectedItem.bunker_id);
				}
			}
			
			public function bindLocatie(bunker: Object, locatie: Locatie) : void {
				bunker.gemeente = BindingUtils.comboboxToString(locatie.cb_gemeente);
				bunker.deelgemeente = BindingUtils.comboboxToString(locatie.cb_deelgemeente);
				bunker.straat = BindingUtils.textinputToString(locatie.ti_straat);
				bunker.toponiem = BindingUtils.textinputToString(locatie.ti_toponiem);
				bunker.x = BindingUtils.textinputToInteger(locatie.ti_x);
				bunker.y = BindingUtils.textinputToInteger(locatie.ti_y);
				bunker.lat = BindingUtils.textinputToFloat(locatie.ti_lat);
				bunker.lng = BindingUtils.textinputToFloat(locatie.ti_lng);
				bunker.kadaster = BindingUtils.textinputToString(locatie.ti_kadaster);
			}
			
			public function bindDocumenten(bunker: Object, documenten: Documenten) : void {
				bunker.availGrondplan = BindingUtils.checkboxToBoolean(documenten.cb_availGrondplan);
				bunker.availOnteigeningsdossier = BindingUtils.checkboxToBoolean(documenten.cb_availOnteigeningsdossier);
				bunker.availLastenboek = BindingUtils.checkboxToBoolean(documenten.cb_availLastenboek);
				bunker.availMilitairBunkerdossier = BindingUtils.checkboxToBoolean(documenten.cb_availMilitairBunkerdossier);
			}
			
			public function bind() : Object {
				var bunker : Object = new Object();
				
				bunker.bunker_id = BindingUtils.textinputToInteger(ti_bunker_id);
				
				bindLocatie(bunker, locatie);
				bindDocumenten(bunker, documenten);
				
				return bunker;
			}
			
		]]>
	</mx:Script>
	
	<mx:Object id="_bunker" />

	<xyz:CallResponder id="bunkerResponder" result="_bunker = event.result" />
	
	<xyz:CallResponder id="bunkerFindAllResponder" />
	
	<mx:RemoteObject id="bunkerService"
		source="kwl.BunkerService" 
		destination="amfphp">
		<mx:method 
			name="save" 
			fault="onFault(event)" 
			result="onResult(event)" />
    </mx:RemoteObject>

	<mx:VBox width="718">
		<mx:DataGrid id="bunkerGrid"
			dataProvider="{bunkerFindAllResponder.lastResult}" 
			width="100%"
			selectedIndex="0"
			valueCommit="bunkerGridChange(event)"
			change="bunkerGridChange(event)">
			<mx:columns>
				<mx:DataGridColumn dataField="bunker_id" headerText="ID" width="40" />
				<mx:DataGridColumn dataField="nummer" headerText="Nummer" width="64" />
				<mx:DataGridColumn dataField="type" headerText="Type" width="128" />
				<mx:DataGridColumn dataField="gemeente" headerText="Gemeente" />
				<mx:DataGridColumn dataField="deelgemeente" headerText="Deelgemeente" />
				<mx:DataGridColumn dataField="straat" headerText="Straat" />
			</mx:columns>
		</mx:DataGrid>
		<mx:HBox>
			<mx:FormItem label="ID" horizontalAlign="left">
				<mx:TextInput id="ti_bunker_id" editable="false" width="64" text="{_bunker.bunker_id}" />
			</mx:FormItem>
			<mx:FormItem label="Nummer" horizontalAlign="left">
				<mx:TextInput editable="false" width="64" text="{_bunker.nummer}" />
			</mx:FormItem>
			<mx:FormItem label="Type">
				<mx:TextInput editable="false" width="128" text="{_bunker.type}" />
			</mx:FormItem>
		</mx:HBox>
		<mx:TabNavigator width="100%" height="360" creationPolicy="all">
			<bunkerFiche:Locatie id="locatie" label="Locatie" data="{_bunker}" />
			<bunkerFiche:Documenten id="documenten" label="Documenten" data="{_bunker}" />
			<bunkerFiche:Fotos label="Fotos" data="{_bunker}" />
			<bunkerFiche:Contacten label="Contacten" data="{_bunker}" />
			<bunkerFiche:Links label="Links" data="{_bunker}" />
			<bunkerFiche:Bescherming label="Bescherming" data="{_bunker}" />
			<bunkerFiche:Opmerkingen label="Opmerkingen" data="{_bunker}" />
			<bunkerFiche:Bezoeken label="Bezoeken" data="{_bunker}" />
		</mx:TabNavigator>
		<mx:Button label="save" click="bunkerService.save(bind());"/>
	</mx:VBox>
	
</mx:Application>
